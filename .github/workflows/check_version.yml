name: Check Version
on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
jobs:
  check_version:
    runs-on: ubuntu-latest
    steps:
    - name: Check version
      run: |
        # Get version from dockerd
        DOCKERD_V=$(curl -s \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/moby/moby/releases/latest" | jq -r '.tag_name')
        
        # Get version from this repo
        AVAILABLE_V=$(curl -s \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r '.tag_name')
        
        # Check if versions are empty or null
        if [ -z "$DOCKERD_V" ] || [ "$DOCKERD_V" = "null" ] || [ -z "$AVAILABLE_V" ] || [ "$AVAILABLE_V" = "null" ]; then
          echo "Couldn't get Version numbers"
          exit 1
        fi

        # Cleanup Docker version
        DOCKERD_V=${DOCKERD_V#*-}

        if [ "${DOCKERD_V#v}" != "${AVAILABLE_V#v}" ]; then
          echo "Newer version found: v${DOCKERD_V#v}"
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/docker.yml/dispatches" \
            -d "{\"ref\":\"master\"}"
        else
          echo "Nothing to do"
        fi
